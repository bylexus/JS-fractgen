<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="css/yaml/core/base.css" type="text/css" />
<link rel="stylesheet" href="css/yaml/screen/typography.css" type="text/css" />
<link rel="stylesheet" href="css/yaml/forms/gray-theme.css" type="text/css" />  


<style type="text/css">
/*
 * |-------------------------------------------------------|
 * | sidebar         |    content                          |
 * | col 3 | fixed   |    col 1 | flexible                 |
 * |                 |                                     |
 * |-------------------------------------------------------|
 */

.ym-column {
  display: block;
  overflow: hidden;
  padding-left: 300px; /* column width */
  width: auto;
}

.ym-col1 {  /* content */
  position: relative;
  float: left;
  width: 100%;
}

.ym-col3 { /* sidebar */
  position: relative;
  float: left;
  width: 300px; /* column width */
  right: 300px; /* column width */
  *right: 0px; /* fix for ie6 & ie7 */
  margin: 0 0 0 -100%;
}


.settings {
	background-color: #DDD;
	border-right: 1px solid #888;
	font-size: 10pt;
	color: #666;
}
.settings h1 {
	font-size: 12pt;
	font-weight: bold;
	color: #666;
}
.settings h2 {
	font-size: 10pt;
	font-weight: bold;
	color: #666;
} 






#fractCanvas {
	border: 1px solid black;
}
</style>

<script src="jquery-1.7.2.min.js"></script>
<script type="text/javascript">
Object.prototype.clone = function() {
  var i;
  var newObj = (this instanceof Array) ? [] : {};
  for (i in this) {
    if (i == 'clone') continue;
    if (this[i] && typeof this[i] == "object") {
      newObj[i] = this[i].clone();
    } else newObj[i] = this[i]
  } return newObj;
};

var ObjectMerge = function(obj1, obj2) {
	var newObj = {};
	var i;
	for (i in obj1) {
		newObj[i] = obj1[i];
	}
	for (i in obj2) {
		newObj[i] = obj2[i];
	}
	return newObj;
}


var baseColors = [
	{r:0,g:0,b:30},
	{r:253,g:204,b:6},
	{r:186,g:84,b:15},
	{r:0,g:0,b:255},
	{r:180,g:180,b:30},
	{r:103,g:61,b:135},
	{r:255,g:0,b:0},
	{r:0,g:0,b:30},
	{r:255,g:255,b:255},
	{r:230,g:0,b:230},
	{r:0,g:0,b:30},
	{r:255,g:0,b:0},
	{r:255,g:255,b:0},
	{r:255,g:255,b:255}
];

baseColors = [
	{r:0,g:0,b:30},
	{r:128,g:128,b:255},
	{r:200,g:200,b:255},
	{r:64,g:64,b:192},
	{r:0,g:0,b:30}
];
/**/
var colorPalette = [];
var hist = [];
var initial_diameter = null;






var fractParamsMandelbrot = {
	/* Mandelbrot Total as default params */
	max_betrag_quadrat: 4,
	max_iter: 40,
	center_cx: -0.7,
	center_cy: 0,
	diameter_cx: 3.0769,
	iter_func: 'mandelbrot',
	pic_width: 800,
	pic_height: 600,
	min_cx: 0.0,
	max_cx: 0.0,
	min_cy: 0.0,
	max_cy: 0.0,
	punkt_abstand: 0.0,
	nrOfWorkers: 2
};

var fractParamsJulia = {
	/* Mandelbrot Total as default params */
	max_betrag_quadrat: 4,
	max_iter: 80,
	center_cx: 0,
	center_cy: 0,
	diameter_cx: 3.0769,
	iter_func: 'julia',
	pic_width: 800,
	pic_height: 600,
	min_cx: 0.0,
	max_cx: 0.0,
	min_cy: 0.0,
	max_cy: 0.0,
	punkt_abstand: 0.0,
	nrOfWorkers: 2
};



var presets = {
	mandelbrot_total: ObjectMerge(fractParamsMandelbrot,{
		name: 'Mandelbrot Total'
	}),
	mandelbrot_seahorse_valley: ObjectMerge(fractParamsMandelbrot,{
		name: 'Mandelbrot Seahorse Valley',
		max_iter: 100,
		center_cx:  -0.87591,
		center_cy:  0.20464,
		diameter_cx:0.53184
	}),




	julia_total: ObjectMerge(fractParamsJulia, {
		name: 'Julia Total'
	})

};








var fractParams = fractParamsMandelbrot;
//var fractParams = fractParamsJulia;

/* Mandelbrot 'seahorse valley' */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 100;
fractParams.center_cx =  -0.87591;
fractParams.center_cy = 0.20464;
fractParams.diameter_cx = 0.53184;
/**/

/* Mandelbrot "Seahorse" upside down */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 400;
fractParams.center_cx =  -0.743030;
fractParams.center_cy = 0.126433;
fractParams.diameter_cx = 0.016110;
/**/

/* Mandelbrot "Seahorse tail" */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 500;
fractParams.center_cx =  -0.7435669;
fractParams.center_cy = 0.1314023;
fractParams.diameter_cx = 0.0022878;
fractParams.pic_width = 800;
fractParams.pic_height = 600;
/**/

/* Mandelbrot "Seahorse valley" */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 3500;
fractParams.pic_width =  1980;
fractParams.pic_height =  1200;
fractParams.center_cx =  -0.74364409961;
fractParams.center_cy = 0.13182604688;
fractParams.diameter_cx = 0.00000066208;
/**/

/* Mandelbrot "Antenna satelite" */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 3000;
fractParams.pic_width =  600;
fractParams.pic_height =  400;
fractParams.center_cx =  -0.743644786;
fractParams.center_cy = 0.1318252536;
fractParams.diameter_cx = .0000029336;
fractParams.nrOfWorkers = 4;
/**/

/* Mandelbrot my own */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 400;
fractParams.center_cx =  0.20070234179688;
fractParams.center_cy = -0.56375779101563;
fractParams.diameter_cx = 0.02403828125;
fractParams.pic_width =  800;
fractParams.pic_height =  600;
/**/

function pushHist(params, imageData) {
	hist.push({
		fractParams: params.clone(),
		imageData: imageData
	});
	if (hist.length > 1) {
		$('#backBtn').attr('disabled',false);
	}
}

function popHist() {
	$('#backBtn').attr('disabled',true);
	if (hist.length > 1) {
		var context = $('#fractCanvas')[0].getContext("2d");
		hist.pop();
		var h = hist[hist.length-1];
		fractParams = h.fractParams.clone();
		context.putImageData(h.imageData,0,0);
		createColorPalette();
		updateInfo();
		if (hist.length > 1) {
			$('#backBtn').attr('disabled',false);
		}
	}
}



function drawFract() {
	var workers = [];
	var worker;
	var i;
	var nrOfWorkers = fractParams.nrOfWorkers || 2;
	var canvas = $('#fractCanvas')[0];
    var context = canvas.getContext("2d");
    var imageData;
    var startTime;
    var endTime;

    context.clearRect(0, 0, canvas.width, canvas.height);
    imageData = context.getImageData(0,0,fractParams.pic_width, fractParams.pic_height);

    startTime = new Date();
    $('#progressBars').empty();
	for (i = 0; i < nrOfWorkers; i++) {
		worker = new Worker('fractWorker.js');
		workers.push({worker:worker,done: false});

		$('#progressBars').append('<div>Progress Worker '+i+': <div style="display:inline-block;border:1px solid #888;width: 400px;"><div id="progress'+i+'" style="width: 0%;background-color: blue;">&nbsp;</div></div><img id="loader'+i+'" src="loader.gif" border="" /></div>');

		(function(w,windex){
			var pBar = $('#progress'+windex);
			w.addEventListener('message',function(e) {
		    	if (e.data.msg === 'result') {
		    		for (var j = 0; j < e.data.data.length;j++) {
		    			col = e.data.data[j];
						index = (e.data.x + (fractParams.pic_height - (e.data.params.from_y+j) - 1)* imageData.width) * 4;
						imageData.data[index+0] = col.r;
						imageData.data[index+1] = col.g;
						imageData.data[index+2] = col.b;
						imageData.data[index+3] = 255;
		    		}
		    		if (e.data.x % 30 === 0) {
		    			// only update progress bar every 30th result:
		    			pBar.css('width',Math.floor(e.data.done*100)+"%");
		    			//pBar.html(Math.floor(e.data.done*100)+"%");
		    		}
		    		
		    	}
		    	if (e.data.msg === 'done') {
		    		workers[e.data.worker].done = true;
		    		pBar.css('width',"100%");
		    		$('#loader'+e.data.worker).hide();
		    		var checkDone = true;
		    		for (var wi = 0; wi < workers.length;wi++) {
		    			if (workers[wi].done !== true) {
		    				checkDone = false;
		    			}
		    		}
		    		if (checkDone) {
		    			pushHist(fractParams,imageData);
		    			context.putImageData(imageData,0,0);
		    			endTime = new Date();
						updateInfo(endTime.getTime() - startTime.getTime());
		    		}
		    	}
		    	if (e.data.msg === 'log') {
		    		console.log(e.data.data);
		    	}
			
			});
		    var msg = {
				msg: 'start',
				worker: windex,
				fractParams: fractParams,
				from_x: ((fractParams.pic_width/nrOfWorkers)|0)*i,
				from_y: 0,
				to_x: ((fractParams.pic_width/nrOfWorkers)|0)*(i+1)-1,
				to_y: fractParams.pic_height-1,
				colors: colorPalette
			};
			w.postMessage(msg);
		})(worker,i);
	}

	
	

    
    

	
}

function updateInfo(milisecsUsed) {
	$('#iterInfo').html(fractParams.max_iter);
	$('#minXInfo').html(fractParams.min_cx);
	$('#minYInfo').html(fractParams.min_cy);
	$('#maxXInfo').html(fractParams.max_cx);
	$('#maxYInfo').html(fractParams.max_cy);
	$('#zoomInfo').html(initial_diameter / fractParams.diameter_cx);
	$('#timeInfo').html(milisecsUsed + " ms");
	drawColorPalette();
}


function init() {
	if (initial_diameter == null) {
		initial_diameter = fractParams.diameter_cx;
	}
	var aspect, fract_width, fract_height;
	$('#fractCanvas').width(fractParams.pic_width);
	$('#fractCanvas').height(fractParams.pic_height);
	$('#fractCanvas').attr('width',fractParams.pic_width);
	$('#fractCanvas').attr('height',fractParams.pic_height);

	aspect = fractParams.pic_width / fractParams.pic_height;
	fract_width = fractParams.diameter_cx;
	fract_height = fractParams.diameter_cx / aspect;
	console.log(aspect, fract_width, fract_height);

	fractParams.min_cx = fractParams.center_cx - (fract_width / 2);
	fractParams.max_cx = fractParams.min_cx + fract_width;
	fractParams.min_cy = fractParams.center_cy - (fract_height / 2);
	fractParams.max_cy = fractParams.min_cy + fract_height;

	fractParams.punkt_abstand = (fractParams.max_cx - fractParams.min_cx) / fractParams.pic_width;

	createColorPalette();
}

function createColorPalette() {
	// Init color palette
	colorPalette = [];
	var stepsPerFade = fractParams.max_iter / (baseColors.length-1);
	var actBase;
	var nextBase;
	var rStep,gStep,bStep;
	var r,g,b;

	for (var i = 0; i < baseColors.length - 1; i++) {
		actBase = baseColors[i];
		nextBase = baseColors[i+1];
		r = actBase.r;
		g = actBase.g;
		b = actBase.b;
		rStep = (nextBase.r-actBase.r) / stepsPerFade;
		bStep = (nextBase.b-actBase.b) / stepsPerFade;
		gStep = (nextBase.g-actBase.g) / stepsPerFade;
		for (var j = 0; j < stepsPerFade;j++) {
			colorPalette.push({
				r:r|0,
				g:g|0,
				b:b|0
			});
			r += rStep;
			g += gStep;
			b += bStep;
		}
	}

	console.log('colors',colorPalette.length);
}


function drawColorPalette() {
	var cont = $('#colorPalette');
	var el;
	var r,g,b;
	cont.empty();
	var index = 0;
	for (var i = 0; i < 600; i++) {
		index = Math.floor(i/600*colorPalette.length);
		r = colorPalette[index].r;
		g = colorPalette[index].g;
		b = colorPalette[index].b;
		el = $('<div style="display:inline-block; width:1px; height: 20px;background-color: rgb('+r+','+g+','+b+');"></div>');
		cont.append(el);
	}
}

function loadPreset(preset) {
	$('#pic_width').val(preset.pic_width);
	$('#pic_height').val(preset.pic_height);

	$('#center_cx').val(preset.center_cx);
	$('#center_cy').val(preset.center_cy);

	$('#diameter_x').val(preset.diameter_cx);

	$('#max_iter').val(preset.max_iter);
	$('#max_betrag_quadrat').val(preset.max_betrag_quadrat);
	$('#iter_func').val(preset.iter_func);
	$('#nr_of_workers').val(preset.nrOfWorkers);
}


function onPageReady() {
	var i;
	
	// Fill presets select:
	var presetsSelect = $('#presets').empty();
	var el;
	for (i in presets) {
		if (typeof i === 'string') {
			el = $('<option value="'+i+'">'+presets[i].name+'</option>');
			presetsSelect.append(el);
		}
	}
	loadPreset(presets[presetsSelect.first().val()]);
	presetsSelect.on('change',function() {
		loadPreset(presets[$(this).val()]);
	});

}


$(document).ready(function(){
	onPageReady();





	init();
	$('#startCalcBtn').on('click',function() {
		init();
		drawFract();
	});

	$('#backBtn').on('click',function() {
		popHist();
	});
	$('#backBtn').attr('disabled',true);

	$('#savePngBtn').on('click',function() {
		$('#outputImage')[0].src = $('#fractCanvas')[0].toDataURL('image/png');
	});


	$('#fractCanvas').on('click', function(ev){
		var offsetX, offsetY;

		console.log(ev);
		fractParams.diameter_cx *= 0.5;
		fractParams.max_iter = (fractParams.max_iter*1.3) | 0;

		offsetX = ev.pageX - $(this).offset().left;
		offsetY = ev.pageY - $(this).offset().top;

		fractParams.center_cx = fractParams.min_cx + offsetX * fractParams.punkt_abstand;
		fractParams.center_cy = fractParams.max_cy - offsetY * fractParams.punkt_abstand;
		init();
		drawFract();
	});
});

</script>
</head>

<body>
	

		


	<header>
		<div class="ym-wrapper">
	      	<div class="ym-wbox">
			    <h1>Fractal Generator using HTML5/WebWorkers</h1>
				<p>Click into the fractal to dive deeper.</p>
	      	</div>
      	</div>
		
	</header>

	<div class="ym-column">
  		<div class="ym-col1">
		    <div class="ym-cbox">
					<div id="output">
						<canvas id="fractCanvas">

						</canvas>
						
						<div id="info">
							<div id="progressBars">
							</div>
							
							<span>Time used:</span><span id="timeInfo"></span><br />
							<span>Scale level: </span><span id="zoomInfo"></span> <br />
							<span>minX: </span><span id="minXInfo"></span> 
							<span>minY: </span><span id="minYInfo"></span> 
							<span>maxX: </span><span id="maxXInfo"></span> 
							<span>maxY: </span><span id="maxYInfo"></span> 
							<span>Iterations used:</span><span id="iterInfo"></span>
						</div>
						<div id="colorPalette"></div>

						<img id="outputImage" />
					</div>
				</div>
		    </div>
	  	



	  	<!-- S I D E B A R -->
	  	<div class="ym-col3 settings">
		    <div class="ym-cbox">
				<h1>Fractal settings</h1>
				
				<form class="ym-form ym-columnar" onsubmit="return false">
					<h2>Dimension</h2>
					<div class="ym-fbox-text">
					  <label for="pic_width">Pixel W:</label>
					  <input type="text" name="pic_width" id="pic_width" />
					</div>
					<div class="ym-fbox-text">
					  <label for="pic_height">Pixel H:</label>
					  <input type="text" name="pic_height" id="pic_height" />
					</div>
					<div class="ym-fbox-text">
					  <label for="center_cx">Center cx:</label>
					  <input type="text" name="center_cx" id="center_cx" />
					</div>
					<div class="ym-fbox-text">
					  <label for="center_cy">Center cy:</label>
					  <input type="text" name="center_cy" id="center_cy" />
					</div>
					<div class="ym-fbox-text">
					  <label for="diameter_x">Diameter x:</label>
					  <input type="text" name="diameter_x" id="diameter_x" />
					</div>

					<h2>Calculation settings</h2>
					<div class="ym-fbox-text">
					  <label for="max_iter">max. Iters:</label>
					  <input type="text" name="max_iter" id="max_iter" />
					</div>
					<div class="ym-fbox-text">
					  <label for="max_betrag_quadrat">max. |Z|^2:</label>
					  <input type="text" name="max_betrag_quadrat" id="max_betrag_quadrat" />
					</div>
					<div class="ym-fbox-select">
					  <label for="iter_func">Function:</label>
					  <select id="iter_func" name="iter_func">
					  	<option value="mandelbrot">Mandelbrot</option>
					  	<option value="julia">Julia</option>
					  </select>
					</div>
					<div class="ym-fbox-text">
					  <label for="nr_of_workers"># Workers:</label>
					  <input type="text" name="nr_of_workers" id="nr_of_workers" />
					</div>
					<div class="ym-fbox-button">
						<button id="startCalcBtn" class="ym-play">Start Calc</button><br />
						<button id="backBtn">Back</button>
						<button id="savePngBtn">Save as PNG</button>
					</div>
				</form>

				<h2>Presets</h2>
				<form class="ym-form ym-columnar" onsubmit="return false">
					<h2>Fractals</h2>
					<div class="ym-fbox-select">
						<select id="presets" name="presets">

						</select>
					</div>
					<h2>Color Schemes</h2>
					<div class="ym-fbox-select">
						<select id="presets" name="colors">

						</select>
					</div>
				</form>
		    </div>
	  	</div>
	</div>
		

</body>
</html>