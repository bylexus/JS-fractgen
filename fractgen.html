<!DOCTYPE html>
<html>
<head>
<style type="text/css">
#fractCanvas {
	border: 1px solid black;
}
</style>

<script src="jquery-1.7.2.min.js"></script>
<script type="text/javascript">
Object.prototype.clone = function() {
  var i;
  var newObj = (this instanceof Array) ? [] : {};
  for (i in this) {
    if (i == 'clone') continue;
    if (this[i] && typeof this[i] == "object") {
      newObj[i] = this[i].clone();
    } else newObj[i] = this[i]
  } return newObj;
};


function iter_mandelbrot(cx,cy,max_betrag_quadrat, max_iter) {
	betrag_quadrat = 0;
	iter = 0;
	x = 0;
	y = 0;

	while (betrag_quadrat <= max_betrag_quadrat && iter < max_iter) {
		xt = x * x - y*y + cx;
		yt = 2*x*y + cy;
		x = xt;
		y = yt;
		iter += 1;
		betrag_quadrat = x*x + y*y;
	}
	return iter;

}

function iter_julia(cx,cy,max_betrag_quadrat, max_iter) {
	betrag_quadrat = 0;
	iter = 0;
	x = cx;
	y = cy;

	var julia_cx = -0.8;
	var julia_cy = 0.2;

	while (betrag_quadrat <= max_betrag_quadrat && iter < max_iter) {
		xt = x * x - y*y + julia_cx;
		yt = 2*x*y + julia_cy;
		x = xt;
		y = yt;
		iter += 1;
		betrag_quadrat = x*x + y*y;
	}
	return iter;
}

function choose_color(iters, max_iters,x,y) {
	var nrOfCols = colorPalette.length;
	var perc = iters / max_iters;
	var col = colorPalette[iters % nrOfCols];
	if (iters >= max_iters) {
		if (x % 8  === 0 && y % 8 === 0)	{
			return {r:64,g:64,b:64};
		} else {
			return {r:0,g:0,b:0};
			
		}
	} 

	return col;
}


var baseColors = [
	{r:0,g:0,b:30},
	{r:0,g:0,b:255},
	{r:180,g:180,b:30},
	{r:255,g:255,b:255},
	{r:255,g:0,b:0},
	{r:0,g:0,b:30},
	{r:255,g:255,b:255},
	{r:230,g:0,b:230},
	{r:0,g:0,b:30},
	{r:255,g:0,b:0},
	{r:255,g:255,b:0},
	{r:255,g:255,b:255}
/*

	{r:255,g:50,b:80},
	{r:255,g:255,b:255},
	{r:100,g:255,b:10},
	{r:0,g:180,b:0},
	{r:33,g:66,b:88},
	{r:255,g:255,b:255}*/
];
var colorPalette = [];
var hist = [];
var initial_diameter = null;

var fractParamsMandelbrot = {
	/* Mandelbrot Total as default params */
	max_betrag_quadrat: 4,
	max_iter: 40,
	center_cx: -0.7,
	center_cy: 0,
	diameter_cx: 3.0769,
	iter_func: iter_mandelbrot,
	pic_width: 800,
	pic_height: 600,
	min_cx: 0.0,
	max_cx: 0.0,
	min_cy: 0.0,
	max_cy: 0.0,
	punkt_abstand: 0.0
};

var fractParamsJulia = {
	/* Mandelbrot Total as default params */
	max_betrag_quadrat: 4,
	max_iter: 80,
	center_cx: 0,
	center_cy: 0,
	diameter_cx: 3.0769,
	iter_func: iter_mandelbrot,
	pic_width: 800,
	pic_height: 600,
	min_cx: 0.0,
	max_cx: 0.0,
	min_cy: 0.0,
	max_cy: 0.0,
	punkt_abstand: 0.0
};

var fractParams = fractParamsMandelbrot;

/* Mandelbrot 'seahorse valley' */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 100;
fractParams.center_cx =  -0.87591;
fractParams.center_cy = 0.20464;
fractParams.diameter_cx = 0.53184;
/**/

/* Mandelbrot "Seahorse" upside down */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 400;
fractParams.center_cx =  -0.743030;
fractParams.center_cy = 0.126433;
fractParams.diameter_cx = 0.016110;
/**/

/* Mandelbrot "Seahorse tail" */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 1000;
fractParams.center_cx =  -0.7435669;
fractParams.center_cy = 0.1314023;
fractParams.diameter_cx = 0.0022878;
/**/

/* Mandelbrot "Seahorse valley" */

fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 3000;
fractParams.pic_width =  320;
fractParams.pic_height =  200;
fractParams.center_cx =  -0.74364409961;
fractParams.center_cy = 0.13182604688;
fractParams.diameter_cx = 0.00000066208;
/**/

/* Mandelbrot my own */
/*
fractParams.max_betrag_quadrat = 4;
fractParams.max_iter = 400;
fractParams.center_cx =  0.20070234179688;
fractParams.center_cy = -0.56375779101563;
fractParams.diameter_cx = 0.02403828125;
fractParams.pic_width =  800;
fractParams.pic_height =  600;
/**/

function pushHist(params, imageData) {
	hist.push({
		fractParams: params.clone(),
		imageData: imageData
	});
	if (hist.length > 1) {
		$('#backBtn').attr('disabled',false);
	}
}

function popHist() {
	$('#backBtn').attr('disabled',true);
	if (hist.length > 1) {
		var context = $('#fractCanvas')[0].getContext("2d");
		hist.pop();
		var h = hist[hist.length-1];
		fractParams = h.fractParams.clone();
		context.putImageData(h.imageData,0,0);
		createColorPalette();
		updateInfo();
		if (hist.length > 1) {
			$('#backBtn').attr('disabled',false);
		}
	}
}



function drawFract() {
	var worker = new Worker('worker.js');
	var canvas = $('#fractCanvas')[0];
    var context = canvas.getContext("2d");
    var progressInfo = $('#progressInfo');

    context.clearRect(0, 0, canvas.width, canvas.height);
    var imageData = context.getImageData(0,0,fractParams.pic_width, fractParams.pic_height);
    worker.addEventListener('message',function(e) {
    	if (e.data.msg === 'result') {
    		for (var j = 0; j < e.data.data.length;j++) {
    			col = choose_color(e.data.data[j], fractParams.max_iter,e.data.x,j);

				index = (e.data.x + (fractParams.pic_height - j - 1)* imageData.width) * 4;
				imageData.data[index+0] = col.r;
				imageData.data[index+1] = col.g;
				imageData.data[index+2] = col.b;
				imageData.data[index+3] = 255;
    		}
    		progressInfo.html(Math.floor(e.data.x/fractParams.pic_width*100)+"%");
    	}
    	if (e.data.msg === 'done') {
    		pushHist(fractParams,imageData);
    		progressInfo.html("100%");
			context.putImageData(imageData,0,0);
			updateInfo();
    	}
		
	});
    var msg = {
		msg: 'start',
		width: fractParams.pic_width,
		height: fractParams.pic_height,
		min_cx: fractParams.min_cx,
		min_cy: fractParams.min_cy,
		punkt_abstand: fractParams.punkt_abstand,
		max_betrag_quadrat: fractParams.max_betrag_quadrat,
		max_iter: fractParams.max_iter
	};
	worker.postMessage(msg);

	
}

function updateInfo() {
	$('#iterInfo').html(fractParams.max_iter);
	$('#minXInfo').html(fractParams.min_cx);
	$('#minYInfo').html(fractParams.min_cy);
	$('#maxXInfo').html(fractParams.max_cx);
	$('#maxYInfo').html(fractParams.max_cy);
	$('#zoomInfo').html(initial_diameter / fractParams.diameter_cx);
	drawColorPalette();
}


function init() {
	if (initial_diameter == null) {
		initial_diameter = fractParams.diameter_cx;
	}
	var aspect, fract_width, fract_height;
	$('#fractCanvas').width(fractParams.pic_width);
	$('#fractCanvas').height(fractParams.pic_height);
	$('#fractCanvas').attr('width',fractParams.pic_width);
	$('#fractCanvas').attr('height',fractParams.pic_height);

	aspect = fractParams.pic_width / fractParams.pic_height;
	fract_width = fractParams.diameter_cx;
	fract_height = fractParams.diameter_cx / aspect;
	console.log(aspect, fract_width, fract_height);

	fractParams.min_cx = fractParams.center_cx - (fract_width / 2);
	fractParams.max_cx = fractParams.min_cx + fract_width;
	fractParams.min_cy = fractParams.center_cy - (fract_height / 2);
	fractParams.max_cy = fractParams.min_cy + fract_height;

	fractParams.punkt_abstand = (fractParams.max_cx - fractParams.min_cx) / fractParams.pic_width;

	createColorPalette();
}

function createColorPalette() {
	// Init color palette
	colorPalette = [];
	var stepsPerFade = fractParams.max_iter / (baseColors.length-1);
	var actBase;
	var nextBase;
	var rStep,gStep,bStep;
	var r,g,b;

	for (var i = 0; i < baseColors.length - 1; i++) {
		actBase = baseColors[i];
		nextBase = baseColors[i+1];
		r = actBase.r;
		g = actBase.g;
		b = actBase.b;
		rStep = (nextBase.r-actBase.r) / stepsPerFade;
		bStep = (nextBase.b-actBase.b) / stepsPerFade;
		gStep = (nextBase.g-actBase.g) / stepsPerFade;
		for (var j = 0; j < stepsPerFade;j++) {
			colorPalette.push({
				r:r|0,
				g:g|0,
				b:b|0
			});
			r += rStep;
			g += gStep;
			b += bStep;
		}
	}

	console.log('colors',colorPalette.length);
}


function drawColorPalette() {
	var cont = $('#colorPalette');
	var el;
	var r,g,b;
	cont.empty();
	var index = 0;
	for (var i = 0; i < 600; i++) {
		index = Math.floor(i/600*colorPalette.length);
		r = colorPalette[index].r;
		g = colorPalette[index].g;
		b = colorPalette[index].b;
		el = $('<div style="display:inline-block; width:1px; height: 20px;background-color: rgb('+r+','+g+','+b+');"></div>');
		cont.append(el);
	}
}


$(document).ready(function(){
	init();
	$('#startCalcBtn').on('click',function() {
		init();
		drawFract();
	});

	$('#backBtn').on('click',function() {
		popHist();
	});
	$('#backBtn').attr('disabled',true);

	$('#savePngBtn').on('click',function() {
		$('#outputImage')[0].src = $('#fractCanvas')[0].toDataURL('image/png');
	});


	$('#fractCanvas').on('click', function(ev){
		console.log(ev);
		fractParams.diameter_cx *= 0.5;
		fractParams.max_iter = (fractParams.max_iter*1.3) | 0;
		fractParams.center_cx = fractParams.min_cx + ev.offsetX * fractParams.punkt_abstand;
		fractParams.center_cy = fractParams.max_cy - ev.offsetY * fractParams.punkt_abstand;
		init();
		drawFract();
	});
});

</script>
</head>

<body>
	<h1>Fractal Generator</h1>
	<p>Click into the fractal to dive deeper.</p>
	<div id="settings">

	</div>

	<div id="output">
		<canvas id="fractCanvas">

		</canvas>
		<button id="startCalcBtn">Start Calc</button>
		<button id="backBtn">Back</button>
		<button id="savePngBtn">Save as PNG</button>
		<div id="info">
			<span>Progress:</span><span id="progressInfo"></span><br />
			<span>Scale level: </span><span id="zoomInfo"></span> <br />
			<span>minX: </span><span id="minXInfo"></span> 
			<span>minY: </span><span id="minYInfo"></span> 
			<span>maxX: </span><span id="maxXInfo"></span> 
			<span>maxY: </span><span id="maxYInfo"></span> 
			<span>Iterations used:</span><span id="iterInfo"></span>
		</div>
		<div id="colorPalette"></div>

		<img id="outputImage" />
	</div>

</body>
</html>